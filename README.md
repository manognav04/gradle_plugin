# dw-gradle-plugin

# Requirements

1. Download and Install OpenJDK 11 or newer.
   - __Option 1__: Download pre-packaged JDK with certificates at https://scm.starbucks.com/dw/openjdk/releases/tag/v17
   - __Option 2__: download the latest JDK from https://jdk.java.net/17/ and add Netskope certificates.
     ```
      keytool -import \
			-alias ca.starbucksdev.goskope.com.crt \
			-file certs/ca.starbucksdev.goskope.com.crt \
			-storepass changeit -noprompt \
			-keystore $JAVA_HOME/lib/security/cacerts
         
      keytool -import \
			-alias caadmin.netskope.com.crt \
			-file certs/caadmin.netskope.com.crt \
			-storepass changeit -noprompt \
			-keystore $JAVA_HOME/lib/security/cacerts
     ```
2. Setup JAVA_HOME to match the directory where OpenJDK is located.
   Example java home at the end of your `.bashrc`
   ```
   export JAVA_HOME=/opt/openjdk-17
   ```
3. (__Optional__): If you are not setting up a new project, then this step can be skipped.  For existing projects, use the provided `./gradlew` wrapper script. I you are setting up a new project, then dwnload the latest distribution of gradle (Installation instructions https://gradle.org/install/).  If You 
4. [Setup gradle.properties](Setup-gradleproperties)

## Setup gradle.properties
1. [Generate a personal Github Access Token](#Generate-a-personal-Github Access-Token)
2. [Generate a Maven Personal Access Token](#Generate-an-Azure-Client-ID-and-Key)
3. [Generate an Azure Client ID and Key](#Generate-an-Azure-Client-ID-and-Key)
4. Add the generated tokens and keys to `$HOME/.gradle/gradle.properties`
    ```properties
    github.access.token=<github access token>
    maven.pass=<personal access token from Step 1>
    az.client.id=<MyDaily-dev principal id>
    az.client.key=<MyDaily-dev principal key>
    ```
   Note: On Windows the path is `%homepath%\.gradle\gradle.properties`

## Setup Gralde for a new project.

- Create Gradle Files
    ```bash
    gradle init
    ```
- Edit `build.grade` and add tasks. See examples of build.gradle
- Standard expected tasks are
    - clean
    - build
    - test
    - lint
    - pack
    - release
    - deployDev
    - deployTest
    - deployProd

## Example build.gradle for Node / Docker

```groovy
/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/7.2/samples
 */
buildscript {
    repositories {
        mavenLocal()
        maven {
            url 'https://pkgs.dev.azure.com/PartnerDevPlatform/_packaging/PartnerDevPlatform/maven/v1'
            name 'PartnerDevPlatform'
	    credentials { username = 'PartnerDevPlatform'; password = System.env.MAVEN_PASS ?: project.property('maven.pass') }
        }
    }
    dependencies {
        classpath("com.starbucks.dw.gradle:plugin:1.2.+")
    }
}


plugins {
    id "com.github.node-gradle.node" version "3.1.0"
    // https://github.com/node-gradle/gradle-node-plugin/blob/master/docs/usage.md
}

apply plugin: "com.starbucks.dw.gradle"

task build(type: NpmTask) {
    environment = [
            "SBUXDW_NPM_READ_TOKEN": dw.getSecret("https://s00354nkvt000001dev.vault.azure.net/secrets/NpmReadToken")
    ]
    args = ['install'] // npm install
}

task test(type: NpmTask, dependsOn: 'build') {
    environment = [
            "SBUXDW_NPM_READ_TOKEN": dw.getSecret("https://s00354nkvt000001dev.vault.azure.net/secrets/NpmReadToken")
    ]
    args = ['test'] // npm test
}

task lint(type: NpmTask, dependsOn: 'build') {
    environment = [
            "SBUXDW_NPM_READ_TOKEN": dw.getSecret("https://s00354nkvt000001dev.vault.azure.net/secrets/NpmReadToken")
    ]
    args = ['run', 'lint'] // npm run lint
}

task pack(type: DockerBuildTask) {
    buildArgs = [
            "SBUXDW_NPM_READ_TOKEN": dw.getSecret("https://s00354nkvt000001dev.vault.azure.net/secrets/NpmReadToken")
    ]
    acrName = "s00354ncre000001dev"
    //dockerFile = file("Dockerfile")
}

task release(type: DockerReleaseTask) {
    acrName = "s00354ncre000001dev"
}

task deployDev(type: DockerDeployTask) { // https://scm.starbucks.com/dw/gradle-plugin
    acrName = "s00354ncre000001dev"
    kvName = "s00354nkvt000001dev"
    siteName = "s00354NSIT000031gatewayapidev"
    doFirst {
        health {
            path = "/version"
            expectedOutput = "$majorMinorBuildNo"
        }
    }
}

task deployTest(type: DockerDeployTask) { // https://scm.starbucks.com/dw/gradle-plugin
    acrName = "s00354ncre000001dev"
    kvName = "s00354nkvt000001test"
    siteName = "s00354NSIT000031gatewayapitest"
    doFirst {
        health {
            path = "/version"
            expectedOutput = "$majorMinorBuildNo"
        }
    }
}

task deployProd(type: DockerDeployTask) { // https://scm.starbucks.com/dw/gradle-plugin
    acrName = "s00354ncre000001dev"
    kvName = "s00354nkvt000001test"
    siteName = "s00354NSIT000031gatewayapiprod"
    promotePreRelease = true
    doFirst {
        health {
            path = "/version"
            expectedOutput = "$majorMinorBuildNo"
        }
    }
}

task clean() {
    doLast {
        delete file("node_modules")
        delete file("build")
    }
}
```

## Example build.gradle for Node

```groovy
buildscript {
    repositories {
        mavenLocal()
        maven {
            url 'https://pkgs.dev.azure.com/PartnerDevPlatform/_packaging/PartnerDevPlatform/maven/v1'
            name 'PartnerDevPlatform'
            credentials { username = 'PartnerDevPlatform'; password = System.env.MAVEN_PASS ?: project.property('maven.pass') }
        }
    }
    dependencies {
        classpath("com.starbucks.dw.gradle:plugin:1.0.+")
    }
}

plugins {
    // https://github.com/node-gradle/gradle-node-plugin/blob/master/docs/usage.md
    id "com.github.node-gradle.node" version "3.1.0"
}

apply plugin: "com.starbucks.dw.gradle"

task build(type: NpmTask) {
    environment = [
            "SBUXDW_NPM_READ_TOKEN": dw.getSecret("https://s00354nkvt000001dev.vault.azure.net/secrets/NpmReadToken")
    ]
    args = ['install'] // npm install
}

task test(type: NpmTask, dependsOn: 'build') {
    args = ['test'] // npm test
}

task lint(type: NpmTask, dependsOn: 'build') {
    args = ['run', 'lint'] // npm run lint
}

// https://bmuschko.github.io/gradle-docker-plugin/current/user-guide/
task buildDist(type: NpmTask, dependsOn: "clean") {
    environment = ['SBUXDW_NPM_READ_TOKEN': dw.getSecret("https://s00354nkvt000001dev.vault.azure.net/secrets/NpmReadToken")]
    args = ['install', '-f', '--production']
}

task pack(type: Zip, dependsOn: "buildDist") {
    archiveFileName = "pkg.zip"
    destinationDirectory = buildDir
    from(projectDir) {
        include "swagger.json", "host.json", "newrelic.js", "web.config", "package.json", "package-lock.json"
        include "dist/**", "src/**", "config/**", "node_modules/**"
    }
}

task release(type: ZipReleaseTask) {
    githubUpload { // See GithubReleaseTask for more information about configuring this block
        file = "localasset.zip"
    }
    blobUpload { // See BlobUploadTask for more information about configuring this block
        file = "localfile.zip"          // required
        account = "s00354nsta000005artifact"
        container = "releases"         // defaults to releases
    }
    // Optional block
    blobUpload { // See BlobUploadTask for more information about configuring this block
        file = "localfile.zip"
        account = "s00354nsta000005artifact"
        container = "artifacts"
        pattern = "[commit]-[repo].zip"
    }
}

task deployDev(type: ZipDeployTask) { // https://scm.starbucks.com/dw/gradle-plugin
    siteName = "s00354NSIT000123exampledev" // Required
    kvName = "s00354nkvt000001dev" // Required Key Vault Name
    // deployZip = "pkg.zip" // Optional file to be deployed.  Set to blobDownload.file or githubDownload.file if any of the download blocks are used
    //deploymentSlot = "staging" // Optional.  Defaults to empty (""). If empty, it won't use slots
    //promotePreRelease = false // Optional.  Set to true to mark the release in github as green

    /*
    // Optional githubDownload block.  If used, the `deployZip` field will be set to `githubDownload.file`
    githubDownload {
        file = "localasset.zip" // or file("localasset.zip") // Required
        // pattern = "[repo]-[majorMinorBuildNo].[ext]"; // Optional. e.g.: reponame-1.0.0.zip
    }
    // Optional blobDownload block. If used, the `deployZip` field will be set to `githubDownload.file`
    blobDownload {
        file = "localfile.zip"          // required
        account = "storageaccountname"   // required
        // container = "releases"           // defaults to releases
        // pattern = "[owner]/[repo]/[repo]-[majorMinorBuildNo].[ext]"
        // pattern defaults to `[owner]/[repo]/[repo]-[majorMinorBuildNo].[ext]`
        //      owner = github owner (pcc)
        //      repo  = repo name (sales-api)
        //      majorMinorBuildNo = version with build no (1.0.0)
        //      ext  = file extension, taken from `file` field (zip)
    }
    */

    //
    health { // Optional block.  health check will only be done if this block is present 
        path = "/health" // Optional Defaults to "/health"
        //expectedOutput = "" // Optional. Defaults to empty ("").  If empty it won't verify the output
        //expectedStatus = 200 // Optional.  Defaults to 200.  Will check until response returns 200
        //attempts = 200 // Optional.  Defaults to 200.  Will check 200 times before failing
        //delaySeconds = 5 // Optional. Defaults to 5 Sleep seconds between each attempt
        //startDelaySeconds = 20 // Optional.  Sleep seconds before staring the first attempt

        // Optional. Defaults to 10.  Each attempt consists of this number of request and they all must succeed
        //numberOfRequestsPerAttempt = 10 
    }

    //// Other Fields
    // owner = "pcc" // Optional. Defaults to repository owner
    // repo = "example-api" // Optional. Defaults to repository owner
}

task deployTest(type: ZipDeployTask) { // https://scm.starbucks.com/dw/gradle-plugin
}

task deployProd(type: ZipDeployTask) { // https://scm.starbucks.com/dw/gradle-plugin
}

task clean() {
    doLast {
        delete file("node_modules")
        delete file("build")
    }
}
```

## Task Types

### BlobDownloadTask

```groovy
task exampleBlobDownloadTask(type: BlobDownloadTask) {
    blobDownload {
        file = "localfile.zip"          // required
        account = "storageaccountname"   // required
        // container = "releases"           // defaults to releases
        // pattern = "[owner]/[repo]/[repo]-[majorMinorBuildNo].[ext]"
        // pattern defaults to `[owner]/[repo]/[repo]-[majorMinorBuildNo].[ext]`
        //      owner = github owner (pcc)
        //      repo  = repo name (sales-api)
        //      majorMinorBuildNo = version with build no (1.0.0)
        //      ext  = file extension, taken from `file` field (zip)
    }

    // Supports downloading multiple files by adding more `blobDownload` blocks
    blobDownload {
        file = "localfile2.zip"
        account = "storageaccountname"
        container = "releases"
        pattern = "[owner]/[repo]/[repo]-[majorMinorBuildNo]-file2.[ext]"
    }
}
```

### BlobUploadTask

```groovy

task exampleBlobUploadTask(type: BlobUploadTask) {
    blobUpload {
        file = "localfile.zip"          // required
        account = "storageaccountname"  // required
        container = "releases"         // defaults to releases
        pattern = "[owner]/[repo]/[repo]-[majorMinorBuildNo].[ext]" // blob pattern name
        // pattern defaults to `[owner]/[repo]/[repo]-[majorMinorBuildNo].[ext]`
        //      owner = github owner (pcc)
        //      repo  = repo name (sales-api)
        //      majorMinorBuildNo = version with build no (1.0.0)
        //      ext  = file extension, taken from `file` field (zip)
    }

    // Supports uploading multiple files by adding more `blobUpload` blocks
    blobUpload {
        file = "localfile2.zip"
        account = "storageaccountname"
        container = "releases"
        pattern = "[owner]/[repo]/[repo]-[majorMinorBuildNo]-file2.[ext]" // blob pattern name
    }
}
```

### DockerBuildTask

```groovy
task exampleDockerBuildTask(type: DockerBuildTask) {
    acrName = "s00354ncre000001dev" // Required
    tag = "pcc/my-image-name" // Optional. Defaults to "$owner/$repo". e.g.: pcc/labor-api
    dockerFile = "Dockerfile" // Optional. Defaults to "Dockerfile"
    contextDir = "." // Optional. Defaults to current directory (".")
    buildArgs = [
            "SBUXDW_NPM_READ_TOKEN": dw.getSecret("https://s00354nkvt000001dev.vault.azure.net/secrets/NpmReadToken")
    ]  // optional.  Defaults to empty map
    cacheLayers = true // optional
}
```

### DockerDeployTask

```groovy
task exampleDockerDeployTask(type: DockerDeployTask) {
    acrName = "s00354ncre000001dev" // Required
    //tag = "pcc/my-image-name" // Optional. Defaults to "$owner/$repo". e.g.: pcc/labor-api

    siteName = "" // Required
    kvName = "" // Required
    //deploymentSlot = "staging" // Optional.  Defaults to empty (""). If empty, it won't use slots
    //promotePreRelease = false // Optional.  Set to true to mark the release in github as green

    health { // Optional block.  health check will only be done if this block is present 
        path = "/health" // Optional Defaults to "/health"
        //expectedOutput = "" // Optional. Defaults to empty ("").  If empty it won't verify the output
        //expectedStatus = 200 // Optional.  Defaults to 200.  Will check until response returns 200
        //attempts = 200 // Optional.  Defaults to 200.  Will check 200 times before failing
        //delaySeconds = 5 // Optional. Defaults to 5 Sleep seconds between each attempt
        //startDelaySeconds = 20 // Optional.  Sleep seconds before staring the first attempt

        // Optional. Defaults to 10.  Each attempt consists of this number of request and they all must succeed
        //numberOfRequestsPerAttempt = 10 
    }
}
 ```

### DockerReleaseTask

It will create a release associated to the current commit. If a release for the current commit already exists, then it
will reuse the release tag. It will also upload a docker image to ACR. The remote image name is constructed using the
ACR server name concatenated with the tag name and major, minor and build number. This usually defaults to
`[acrName].azurecr.io/[tag]:[majorMinorBuildno]`. e.g.: s00354ncre000001dev.azurecr.io/pcc/example-api:1.0.35

```groovy
task release(type: DockerReleaseTask) {
    acrName = "s00354ncre000001dev" // Required
    //tag = "pcc/my-image-name" // Optional. Defaults to "$owner/$repo". e.g.: pcc/labor-api
    // owner = "pcc" // Optional. Defaults to repository owner
    // repo = "example-api" // Optional. Defaults to repository owner

    githubUpload {
        file = "localasset.zip" // or file("localasset.zip") // Required
        // pattern = "[repo]-[majorMinorBuildNo].[ext]"; // Optional. e.g.: reponame-1.0.0.zip
    }

    //// Multiple asset uploads are possible
    // githubUpload { file = "localasset.zip" }
}
 ```

### GithubDownloadTask

```groovy
task exampleGithubDownloadTask(type: GithubDownloadTask) {
    githubDownload {
        file = "localasset.zip" // or file("localasset.zip") // Required
        // pattern = "[repo]-[majorMinorBuildNo].[ext]"; // Optional. e.g.: reponame-1.0.0.zip
    }

    // Multiple `githubDownload` blocks are allowed
    githubDownload {
        file = "local-asset-name.zip"
        pattern "asset-name.zip"
    }
    githubDownload {
        file = "local-asset-name-2.zip"
        pattern "asset-name-with-version-[majorMinorBuildNo].zip"
    }
}
```

### GithubReleaseTask

It will create a release associated to the current commit. If a release for the current commit already exists, then it
will reuse the release tag.

```groovy
task release(type: GithubReleaseTask) {
    // owner = "pcc" // Optional. Defaults to repository owner
    // repo = "example-api" // Optional. Defaults to repository owner

    githubUpload { // githubUpload block can be repeated multiple times
        file = "localasset.zip" // or file("localasset.zip") // Required
        // pattern = "[repo]-[majorMinorBuildNo].[ext]"; // Optional. e.g.: reponame-1.0.0.zip
    }
}
```

### ZipDeployTask

```groovy
task deploy(type: ZipDeployTask) {
    // deployZip = "pkg.zip" // Optional file to be deployed.  Set to blobDownload.file or githubDownload.file if any of the download blocks are used
    siteName = "s00354NSIT000123exampledev" // Required
    kvName "s00354nkvt000001dev" // Required Key Vault Name

    /*
    // Optional githubDownload block.  If used, the `deployZip` field will be set to `githubDownload.file`
    githubDownload {
        file = "localasset.zip" // or file("localasset.zip") // Required
        // pattern = "[repo]-[majorMinorBuildNo].[ext]"; // Optional. e.g.: reponame-1.0.0.zip
    }
    // Optional blobDownload block. If used, the `deployZip` field will be set to `githubDownload.file`
    blobDownload {
        file = "localfile.zip"          // required
        account = "storageaccountname"   // required
        // container = "releases"           // defaults to releases
        // pattern = "[owner]/[repo]/[repo]-[majorMinorBuildNo].[ext]"
        // pattern defaults to `[owner]/[repo]/[repo]-[majorMinorBuildNo].[ext]`
        //      owner = github owner (pcc)
        //      repo  = repo name (sales-api)
        //      majorMinorBuildNo = version with build no (1.0.0)
        //      ext  = file extension, taken from `file` field (zip)
    }
    */


    //deploymentSlot = "staging" // Optional.  Defaults to empty (""). If empty, it won't use slots
    //promotePreRelease = false // Optional.  Set to true to mark the release in github as green

    //
    health { // Optional block.  health check will only be done if this block is present 
        path = "/health" // Optional Defaults to "/health"
        //expectedOutput = "" // Optional. Defaults to empty ("").  If empty it won't verify the output
        //expectedStatus = 200 // Optional.  Defaults to 200.  Will check until response returns 200
        //attempts = 200 // Optional.  Defaults to 200.  Will check 200 times before failing
        //delaySeconds = 5 // Optional. Defaults to 5 Sleep seconds between each attempt
        //startDelaySeconds = 20 // Optional.  Sleep seconds before staring the first attempt

        // Optional. Defaults to 10.  Each attempt consists of this number of request and they all must succeed
        //numberOfRequestsPerAttempt = 10 
    }

    //// Other Fields
    // owner = "pcc" // Optional. Defaults to repository owner
    // repo = "example-api" // Optional. Defaults to repository owner
}
 ```

### ZipReleaseTask

It will create a release associated to the current commit. If a release for the current commit already exists, then it
will reuse the release tag.

```groovy
task deploy(type: ZipReleaseTask) {
    // Optional block
    githubUpload { // See GithubReleaseTask for more information about configuring this block
        file = "localasset.zip" // or file("localasset.zip") // Required
    }

    // Optional block
    blobUpload { // See BlobUploadTask for more information about configuring this block
        file = "localfile.zip"          // required
        account = "storageaccountname"  // required
        container = "releases"         // defaults to releases
    }

    //// Other optional fields
    // owner = "pcc" // Optional. Defaults to repository owner
    // repo = "example-api" // Optional. Defaults to repository owner
}
```

## Generate a personal Github Access Token

1. Go to Your Profile > Settings > Developer
   Settins > [Personal Access Token](https://scm.starbucks.com/settings/tokens)
2. Click on Generate new Token and Select `repo` and `write:packages` permissions.
3. Give it a name and Generate the token.

## Generate a Maven Personal Access Token

1. Go to https://dev.azure.com/PartnerDevPlatform/_usersSettings/tokens
2. Make sure you are logged in with your network credentials.
3. Click on `New Token`
4. Give it a name.
5. Set the expiration date to 1 year.
6. Set Scope to `Full access`.
7. Click on `Create`
8. Copy the generated `key`. It will be used on the next step for `maven.pass`.

## Generate an Azure Client ID and Key

<dl>
    <dt>Example for <a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationMenuBlade/Overview/appId/b51aab45-d697-46f2-8ee4-a283e92f0c04/isMSAApp/">MyDaily-dev</a></dt>
    <dd>Instructions can be found at this <a href="https://docs.starbucks.com/display/PTPXE/Create+AD+Client+Secret+and+retrieve+OAuth2+Token">Link</a></dd>
    <dt>Example for <a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationMenuBlade/Overview/appId/8167c748-a7fc-444d-87d3-96c01960f974/isMSAApp/">pdp-client-dev-app</a></dt>
    <dd>Instructions can be found at this <a href="https://docs.starbucks.com/display/PTPXE/Create+AD+Client+Secret+and+retrieve+OAuth2+Token">Link</a></dd>
</dl>

